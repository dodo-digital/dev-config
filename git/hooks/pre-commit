#!/bin/bash
# Global pre-commit hook - blocks commits with critical bugs
# Uses Ultimate Bug Scanner (ubs)

# Skip if ubs not installed
if ! command -v ubs >/dev/null 2>&1; then
  exit 0
fi

# Get the repo root
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)
[[ -z "$REPO_ROOT" ]] && exit 0

# Check if any staged files are supported languages
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|mjs|cjs|py|pyw|c|cc|cpp|cxx|h|hpp|rs|go|java|rb)$')
[[ -z "$STAGED_FILES" ]] && exit 0

echo "Running bug scanner on staged files..."

# Run ubs and capture output
OUTPUT=$(ubs "$REPO_ROOT" --ci 2>&1)
EXIT_CODE=$?

# Check for critical bugs (ubs returns non-zero on critical issues)
if [[ $EXIT_CODE -ne 0 ]]; then
  echo ""
  echo "COMMIT BLOCKED - Critical bugs found:"
  echo "$OUTPUT" | head -100
  echo ""
  echo "Fix the issues above or use 'git commit --no-verify' to bypass."
  exit 1
fi

exit 0
